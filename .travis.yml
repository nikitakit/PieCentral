dist: trusty
sudo: required
language: node_js
node_js:
- "6"
os:
- linux
env:
  - TEST_DIR=dawn
  - TEST_DIR=runtime
before_install:
- mkdir -p artifacts
- if [[ $TEST_DIR = dawn ]] && git tag -l --points-at HEAD | grep dawn; then
    export DEPLOY_ARTIFACTS=1;
  fi
- if [[ $TEST_DIR = runtime ]] && git tag -l --points-at HEAD | grep runtime; then
    export DEPLOY_ARTIFACTS=1;
  fi
- mkdir -p build-deps
- export PATH="$PATH:$PWD/build-deps/bin"
install:
- pushd $TEST_DIR
- make install
- if [[ $DEPLOY_ARTIFACTS = 1 ]]; then
    make artifacts-install;
  fi
- popd
script:
- pushd $TEST_DIR
- make test
- make lint
- if [[ $DEPLOY_ARTIFACTS = 1 ]]; then
    make artifacts;
  fi
- popd
branches:
  only:
  - master
  - /^(dawn)\/.*$/
  - /^(runtime)\/.*$/
  - /^(test)\/.*$/
deploy:
  provider: releases
  api_key:
    secure: "rSWtttUWcMKEJydl5qbR8d0SqHaGlpOJMEosqIA4OggOKZqV+/xDVtXQGrm0Sgf6Ljpi5xhRqVxGe2wOlGYCtAAbcU6NyM+NPezlx7Ffata4SwyW4zviEzis2//CmG2zLGIMHypNBNmq5JrTCK3CckgsLudGkr/JWheOUeNTwYiOFjE29hlzkHpJ+K5x8or7cyOVYDoTyiXNM4NRgRUWmX7e+EbkdWg+Qavwx9gLNu0d/hjER4M2f6Q/cSDPM8csSAq+jg/aG/Dpo3idPVEz3ceTnEs3R9hn+8ms+MWQ1PYQfrRlaoDfgn8vM1WJDKIuXJ6vZemrJVja4/uSoTEAIJ5tzdQzI7mPNoNiPWb8YS+iPU76/ECLWqSkkgyVCynLKppW3Uq1JLwe4Z4j4miI6Qzd9Kazt9WRVlUqIPXKBJhjyg+lUx3Ts23xoi50MP3NCbfYQpdmBVuBWu/5HYM6akfTTc0OaMfymW1UlLVIlKJGC4E7N8a7RC0X06YnpFq3yYmyYcs0eDhb0gPX6pLKjSdMhGvAEFwKi0rlT96yi3iOdM+J07ON5pmpigtbphsJfXF/YT4RRqKnwqvDgoV5p92WbkGoI8mrN+387kSAzfCo/DGWLUwqoUtqxWk3RwZAXMnKpoJCSCLa1sp56QOHy0Ov5cPBQBm4Q7XegKRh98g="
  file: artifacts/*
  file_glob: true
  skip_cleanup: true
  on:
    tags: true
    condition: $DEPLOY_ARTIFACTS = 1
